<!--
  ÍµêÏÇ¨Ïö© ÏàòÏóÖ ÏÉùÏÑ± Î∞è Í¥ÄÎ¶¨ Ïª¥Ìè¨ÎÑåÌä∏
  - ÏàòÏóÖ ÏÉùÏÑ± (Ï£ºÏ†ú, Ïù¥ÎØ∏ÏßÄ, Ï†úÌïúÏãúÍ∞Ñ Îì± ÏÑ§Ï†ï)
  - ÏàòÏóÖ ÏÑ§Ï†ï Î≥ÄÍ≤Ω
  - ÏàòÏóÖ Îã®Í≥Ñ Ï†úÏñ¥
-->
<script>
  import { createEventDispatcher, onMount } from 'svelte';
  import { auth, db, storage } from '$lib/firebase/firebase';
  import { 
    collection, 
    addDoc, 
    doc, 
    updateDoc,
    serverTimestamp 
  } from 'firebase/firestore';
  import { 
    ref, 
    uploadBytes, 
    getDownloadURL 
  } from 'firebase/storage';
  import { 
    lessonSettings,
    updateLessonSettings,
    changeStep,
    getCurrentLesson,
    lessonStep,
    connectedStudentCount,
    wordCollectionProgress,
    sentenceProgress,
    LESSON_STEPS
  } from '$lib/stores';

  const dispatch = createEventDispatcher();

  // Props
  export let classroomId = '';
  export let currentLesson = null;
  export let mode = 'create'; // 'create' | 'manage'

  // Ïª¥Ìè¨ÎÑåÌä∏ ÏÉÅÌÉú
  let showModal = false;
  let isLoading = false;
  let error = '';

  // ÏàòÏóÖ ÏÉùÏÑ± Ìèº Îç∞Ïù¥ÌÑ∞
  let formData = {
    title: '',
    description: '',
    subject: 'Íµ≠Ïñ¥',
    maxWords: 10,
    timeLimit: 30,
    allowAnonymous: true,
    activityImageFile: null,
    activityImageUrl: ''
  };

  // Î∞òÏùëÌòï ÏÉÅÌÉúÎì§
  $: currentStep = $lessonStep;
  $: studentCount = $connectedStudentCount;
  $: wordProgress = $wordCollectionProgress;
  $: sentenceWritingProgress = $sentenceProgress;
  $: settings = $lessonSettings;

  // Í≥ºÎ™© Î™©Î°ù
  const subjects = [
    'Íµ≠Ïñ¥', 'ÏòÅÏñ¥', 'ÏàòÌïô', 'Í≥ºÌïô', 'ÏÇ¨Ìöå',
    'ÏòàÏà†', 'Ï≤¥Ïú°', 'Ï∞ΩÏùòÏ†ÅÏ≤¥ÌóòÌôúÎèô', 'Í∏∞ÌÉÄ'
  ];

  // ÏàòÏóÖ Îã®Í≥Ñ Ïù¥Î¶Ñ
  const stepNames = {
    [LESSON_STEPS.PREPARATION]: 'Ï§ÄÎπÑ',
    [LESSON_STEPS.WORD_COLLECTION]: 'Îã®Ïñ¥ ÏàòÏßë',
    [LESSON_STEPS.SENTENCE_WRITING]: 'Î¨∏Ïû• ÏûëÏÑ±',
    [LESSON_STEPS.SHARING]: 'Í≥µÏú† Î∞è Î∞úÌëú',
    [LESSON_STEPS.COMPLETED]: 'ÏàòÏóÖ ÏôÑÎ£å'
  };

  onMount(() => {
    // Í∏∞Ï°¥ ÏàòÏóÖ Ï†ïÎ≥¥Í∞Ä ÏûàÏúºÎ©¥ ÌèºÏóê Ï±ÑÏö∞Í∏∞
    if (mode === 'manage' && currentLesson) {
      formData = {
        title: currentLesson.title || '',
        description: currentLesson.description || '',
        subject: currentLesson.subject || 'Íµ≠Ïñ¥',
        maxWords: currentLesson.maxWords || 10,
        timeLimit: currentLesson.timeLimit || 30,
        allowAnonymous: currentLesson.allowAnonymous ?? true,
        activityImageFile: null,
        activityImageUrl: currentLesson.activityImage || ''
      };
    }
  });

  /**
   * ÏàòÏóÖ ÏÉùÏÑ±
   */
  async function createLesson() {
    if (!auth.currentUser) {
      error = 'Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.';
      return;
    }

    if (!formData.title.trim()) {
      error = 'ÏàòÏóÖ Ï†úÎ™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.';
      return;
    }

    if (!classroomId) {
      error = 'ÍµêÏã§ Ï†ïÎ≥¥Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§.';
      return;
    }

    try {
      isLoading = true;
      error = '';

      let activityImageUrl = formData.activityImageUrl;

      // Ïù¥ÎØ∏ÏßÄ ÌååÏùºÏù¥ ÏûàÏúºÎ©¥ ÏóÖÎ°úÎìú
      if (formData.activityImageFile) {
        activityImageUrl = await uploadActivityImage(formData.activityImageFile);
      }

      // ÏàòÏóÖ Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ
      const lessonData = {
        title: formData.title.trim(),
        description: formData.description.trim(),
        subject: formData.subject,
        classroomId,
        teacherId: auth.currentUser.uid,
        teacherEmail: auth.currentUser.email,
        
        // ÏàòÏóÖ ÏÑ§Ï†ï
        maxWords: formData.maxWords,
        timeLimit: formData.timeLimit,
        allowAnonymous: formData.allowAnonymous,
        activityImage: activityImageUrl,
        
        // ÏàòÏóÖ ÏÉÅÌÉú
        currentStep: LESSON_STEPS.PREPARATION,
        status: 'active',
        
        // ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      };

      // FirestoreÏóê ÏàòÏóÖ ÏÉùÏÑ±
      const lessonRef = await addDoc(collection(db, 'lessons'), lessonData);

      console.log('üìö ÏàòÏóÖ ÏÉùÏÑ± ÏôÑÎ£å:', lessonRef.id);

      // Ïù¥Î≤§Ìä∏ ÎîîÏä§Ìå®Ïπò
      dispatch('lessonCreated', {
        id: lessonRef.id,
        ...lessonData
      });

      // Î™®Îã¨ Îã´Í∏∞ Î∞è Ìèº Ï¥àÍ∏∞Ìôî
      closeModal();
      resetForm();

    } catch (err) {
      console.error('ÏàòÏóÖ ÏÉùÏÑ± Ïò§Î•ò:', err);
      error = `ÏàòÏóÖ ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${err.message}`;
      
    } finally {
      isLoading = false;
    }
  }

  /**
   * ÏàòÏóÖ ÏÑ§Ï†ï ÏóÖÎç∞Ïù¥Ìä∏
   */
  async function updateSettings() {
    if (!currentLesson) return;

    try {
      isLoading = true;
      error = '';

      let activityImageUrl = formData.activityImageUrl;

      // ÏÉà Ïù¥ÎØ∏ÏßÄ ÌååÏùºÏù¥ ÏûàÏúºÎ©¥ ÏóÖÎ°úÎìú
      if (formData.activityImageFile) {
        activityImageUrl = await uploadActivityImage(formData.activityImageFile);
      }

      const updates = {
        title: formData.title.trim(),
        description: formData.description.trim(),
        subject: formData.subject,
        maxWords: formData.maxWords,
        timeLimit: formData.timeLimit,
        allowAnonymous: formData.allowAnonymous,
        activityImage: activityImageUrl,
        updatedAt: serverTimestamp()
      };

      // Firestore ÏóÖÎç∞Ïù¥Ìä∏
      await updateDoc(doc(db, 'lessons', currentLesson.id), updates);

      // Ïä§ÌÜ†Ïñ¥ ÏóÖÎç∞Ïù¥Ìä∏
      await updateLessonSettings(currentLesson.id, updates);

      console.log('‚öôÔ∏è ÏàòÏóÖ ÏÑ§Ï†ï ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');

      dispatch('lessonUpdated', updates);
      closeModal();

    } catch (err) {
      console.error('ÏàòÏóÖ ÏÑ§Ï†ï ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:', err);
      error = `ÏÑ§Ï†ï ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${err.message}`;
      
    } finally {
      isLoading = false;
    }
  }

  /**
   * ÏàòÏóÖ Îã®Í≥Ñ Î≥ÄÍ≤Ω
   */
  async function handleStepChange(newStep) {
    if (!currentLesson) return;

    try {
      await changeStep(currentLesson.id, newStep);
      console.log(`üìö ÏàòÏóÖ Îã®Í≥Ñ Î≥ÄÍ≤Ω: ${newStep}`);
      
    } catch (err) {
      console.error('ÏàòÏóÖ Îã®Í≥Ñ Î≥ÄÍ≤Ω Ïò§Î•ò:', err);
      error = `Îã®Í≥Ñ Î≥ÄÍ≤Ω Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${err.message}`;
    }
  }

  /**
   * ÌôúÎèô Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú
   */
  async function uploadActivityImage(file) {
    try {
      const timestamp = Date.now();
      const fileName = `lesson-images/${timestamp}-${file.name}`;
      const storageRef = ref(storage, fileName);

      // ÌååÏùº ÏóÖÎ°úÎìú
      const snapshot = await uploadBytes(storageRef, file);
      const downloadURL = await getDownloadURL(snapshot.ref);

      console.log('üñºÔ∏è Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú ÏôÑÎ£å:', downloadURL);
      return downloadURL;

    } catch (err) {
      console.error('Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú Ïò§Î•ò:', err);
      throw new Error('Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
    }
  }

  /**
   * Ïù¥ÎØ∏ÏßÄ ÌååÏùº ÏÑ†ÌÉù Ï≤òÎ¶¨
   */
  function handleImageSelect(event) {
    const file = event.target.files[0];
    if (file) {
      // ÌååÏùº ÌÅ¨Í∏∞ Ï≤¥ÌÅ¨ (5MB Ï†úÌïú)
      if (file.size > 5 * 1024 * 1024) {
        error = 'Ïù¥ÎØ∏ÏßÄ ÌååÏùº ÌÅ¨Í∏∞Îäî 5MB Ïù¥ÌïòÏó¨Ïïº Ìï©ÎãàÎã§.';
        return;
      }

      // ÌååÏùº ÌòïÏãù Ï≤¥ÌÅ¨
      if (!file.type.startsWith('image/')) {
        error = 'Ïù¥ÎØ∏ÏßÄ ÌååÏùºÎßå ÏóÖÎ°úÎìúÌï† Ïàò ÏûàÏäµÎãàÎã§.';
        return;
      }

      formData.activityImageFile = file;

      // ÎØ∏Î¶¨Î≥¥Í∏∞ ÏÉùÏÑ±
      const reader = new FileReader();
      reader.onload = (e) => {
        formData.activityImageUrl = e.target.result;
      };
      reader.readAsDataURL(file);
    }
  }

  /**
   * Î™®Îã¨ Ïó¥Í∏∞
   */
  function openModal() {
    showModal = true;
    error = '';
  }

  /**
   * Î™®Îã¨ Îã´Í∏∞
   */
  function closeModal() {
    showModal = false;
    error = '';
  }

  /**
   * Ìèº Ï¥àÍ∏∞Ìôî
   */
  function resetForm() {
    formData = {
      title: '',
      description: '',
      subject: 'Íµ≠Ïñ¥',
      maxWords: 10,
      timeLimit: 30,
      allowAnonymous: true,
      activityImageFile: null,
      activityImageUrl: ''
    };
  }

  /**
   * Îã§Ïùå Îã®Í≥ÑÎ°ú ÏßÑÌñâ Í∞ÄÎä•ÌïúÏßÄ ÌôïÏù∏
   */
  function canProceedToNext(step) {
    switch (step) {
      case LESSON_STEPS.WORD_COLLECTION:
        return studentCount > 0;
      case LESSON_STEPS.SENTENCE_WRITING:
        return wordProgress > 50; // 50% Ïù¥ÏÉÅ Ï†úÏ∂úÏãú
      case LESSON_STEPS.SHARING:
        return sentenceWritingProgress > 30; // 30% Ïù¥ÏÉÅ Ï†úÏ∂úÏãú
      case LESSON_STEPS.COMPLETED:
        return true;
      default:
        return true;
    }
  }
</script>

<style>
  .lesson-creator {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .lesson-controls {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
  }

  .current-status {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 1rem;
  }

  .status-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
  }

  .status-number {
    font-size: 1.5rem;
    font-weight: bold;
    color: #4285f4;
  }

  .status-label {
    font-size: 0.75rem;
    color: #666;
  }

  .step-controls {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .step-button {
    padding: 0.5rem 1rem;
    border: 2px solid #e0e0e0;
    background: white;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.875rem;
  }

  .step-button:hover {
    border-color: #4285f4;
    color: #4285f4;
  }

  .step-button.active {
    background: #4285f4;
    border-color: #4285f4;
    color: white;
  }

  .step-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .create-button, .settings-button {
    padding: 0.75rem 1.5rem;
    background: #4285f4;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    transition: background 0.2s;
  }

  .create-button:hover, .settings-button:hover {
    background: #3367d6;
  }

  .settings-button {
    background: #666;
  }

  .settings-button:hover {
    background: #555;
  }

  /* Î™®Îã¨ Ïä§ÌÉÄÏùº */
  .modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }

  .modal-content {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
  }

  .modal-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #333;
  }

  .close-button {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #666;
    padding: 0;
    width: 2rem;
    height: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background 0.2s;
  }

  .close-button:hover {
    background: #f0f0f0;
  }

  .form-grid {
    display: grid;
    gap: 1.5rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .form-label {
    font-weight: 500;
    color: #333;
  }

  .form-input, .form-select, .form-textarea {
    padding: 0.75rem;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.2s;
  }

  .form-input:focus, .form-select:focus, .form-textarea:focus {
    outline: none;
    border-color: #4285f4;
  }

  .form-textarea {
    resize: vertical;
    min-height: 100px;
  }

  .checkbox-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .image-upload {
    border: 2px dashed #e0e0e0;
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: border-color 0.2s;
  }

  .image-upload:hover {
    border-color: #4285f4;
  }

  .image-preview {
    margin-top: 1rem;
  }

  .image-preview img {
    max-width: 200px;
    max-height: 150px;
    border-radius: 8px;
    object-fit: cover;
  }

  .error-message {
    color: #dc3545;
    font-size: 0.875rem;
    margin-top: 1rem;
    padding: 0.75rem;
    background: #f8d7da;
    border-radius: 4px;
  }

  .modal-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    margin-top: 2rem;
  }

  .cancel-button {
    padding: 0.75rem 1.5rem;
    background: #6c757d;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
  }

  .cancel-button:hover {
    background: #5a6268;
  }

  .submit-button {
    padding: 0.75rem 1.5rem;
    background: #4285f4;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .submit-button:hover {
    background: #3367d6;
  }

  .submit-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .loading-spinner {
    width: 16px;
    height: 16px;
    border: 2px solid #ffffff40;
    border-top: 2px solid #ffffff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>

<div class="lesson-creator">
  {#if mode === 'create'}
    <!-- ÏàòÏóÖ ÏÉùÏÑ± Î≤ÑÌäº -->
    <div class="lesson-controls">
      <h3>ÏÉàÎ°úÏö¥ ÏàòÏóÖ ÎßåÎì§Í∏∞</h3>
      <button class="create-button" on:click={openModal}>
        <i class="fas fa-plus"></i>
        ÏàòÏóÖ ÏÉùÏÑ±
      </button>
    </div>
    
  {:else if mode === 'manage' && currentLesson}
    <!-- ÏàòÏóÖ Í¥ÄÎ¶¨ Ïù∏ÌÑ∞ÌéòÏù¥Ïä§ -->
    <div class="lesson-controls">
      <h3>{currentLesson.title}</h3>
      <button class="settings-button" on:click={openModal}>
        <i class="fas fa-cog"></i>
        ÏÑ§Ï†ï
      </button>
    </div>

    <!-- ÌòÑÏû¨ ÏÉÅÌÉú ÌëúÏãú -->
    <div class="current-status">
      <div class="status-item">
        <div class="status-number">{studentCount}</div>
        <div class="status-label">Ï∞∏Ïó¨ ÌïôÏÉù</div>
      </div>
      <div class="status-item">
        <div class="status-number">{wordProgress}%</div>
        <div class="status-label">Îã®Ïñ¥ Ï†úÏ∂úÎ•†</div>
      </div>
      <div class="status-item">
        <div class="status-number">{sentenceWritingProgress}%</div>
        <div class="status-label">Î¨∏Ïû• Ï†úÏ∂úÎ•†</div>
      </div>
    </div>

    <!-- Îã®Í≥Ñ Ï†úÏñ¥ Î≤ÑÌäºÎì§ -->
    <div class="step-controls">
      {#each Object.entries(LESSON_STEPS) as [key, step]}
        <button 
          class="step-button {currentStep === step ? 'active' : ''}"
          disabled={!canProceedToNext(step)}
          on:click={() => handleStepChange(step)}
        >
          {stepNames[step]}
        </button>
      {/each}
    </div>
  {/if}
</div>

<!-- ÏàòÏóÖ ÏÉùÏÑ±/ÏÑ§Ï†ï Î™®Îã¨ -->
{#if showModal}
  <div 
    class="modal" 
    role="dialog" 
    aria-modal="true" 
    aria-labelledby="lesson-modal-title"
    on:click={closeModal}
    on:keydown={(e) => {
      if (e.key === 'Escape') {
        closeModal();
      }
    }}
  >
    <div 
      class="modal-content" 
      role="document"
      on:click|stopPropagation
    >
      <div class="modal-header">
        <h2 id="lesson-modal-title" class="modal-title">
          {mode === 'create' ? 'ÏÉà ÏàòÏóÖ ÎßåÎì§Í∏∞' : 'ÏàòÏóÖ ÏÑ§Ï†ï'}
        </h2>
        <button class="close-button" on:click={closeModal}>√ó</button>
      </div>

      <div class="form-grid">
        <!-- Í∏∞Î≥∏ Ï†ïÎ≥¥ -->
        <div class="form-group">
          <label class="form-label" for="lesson-title">ÏàòÏóÖ Ï†úÎ™© *</label>
          <input 
            id="lesson-title"
            class="form-input" 
            type="text" 
            bind:value={formData.title}
            placeholder="Ïòà: Ïó¨Î¶Ñ ÌíçÍ≤Ω Î¨òÏÇ¨ÌïòÍ∏∞"
            maxlength="100"
          />
        </div>

        <div class="form-group">
          <label class="form-label" for="lesson-description">ÏàòÏóÖ ÏÑ§Î™Ö</label>
          <textarea 
            id="lesson-description"
            class="form-textarea"
            bind:value={formData.description}
            placeholder="ÏàòÏóÖ Î™©ÌëúÎÇò Í∞ÑÎã®Ìïú ÏÑ§Î™ÖÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî..."
            maxlength="500"
          ></textarea>
        </div>

        <div class="form-group">
          <label class="form-label" for="lesson-subject">Í≥ºÎ™©</label>
          <select id="lesson-subject" class="form-select" bind:value={formData.subject}>
            {#each subjects as subject}
              <option value={subject}>{subject}</option>
            {/each}
          </select>
        </div>

        <!-- ÌôúÎèô ÏÑ§Ï†ï -->
        <div class="form-group">
          <label class="form-label" for="max-words">ÏµúÎåÄ Îã®Ïñ¥ Ïàò</label>
          <input 
            id="max-words"
            class="form-input" 
            type="number" 
            bind:value={formData.maxWords}
            min="5"
            max="20"
          />
        </div>

        <div class="form-group">
          <label class="form-label" for="time-limit">Ï†úÌïúÏãúÍ∞Ñ (Î∂Ñ)</label>
          <input 
            id="time-limit"
            class="form-input" 
            type="number" 
            bind:value={formData.timeLimit}
            min="10"
            max="90"
          />
        </div>

        <div class="form-group">
          <div class="checkbox-group">
            <input 
              id="allow-anonymous"
              type="checkbox" 
              bind:checked={formData.allowAnonymous}
            />
            <label class="form-label" for="allow-anonymous">ÏùµÎ™Ö Ï∞∏Ïó¨ ÌóàÏö©</label>
          </div>
        </div>

        <!-- ÌôúÎèô Ïù¥ÎØ∏ÏßÄ -->
        <div class="form-group">
          <label class="form-label" for="image-input">ÌôúÎèô Ïù¥ÎØ∏ÏßÄ</label>
          <div 
            class="image-upload" 
            role="button" 
            tabindex="0"
            on:click={() => document.getElementById('image-input').click()}
            on:keydown={(e) => {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                document.getElementById('image-input').click();
              }
            }}
            aria-label="Ïù¥ÎØ∏ÏßÄ ÌååÏùº ÏÑ†ÌÉù"
          >
            <input 
              id="image-input"
              type="file" 
              accept="image/*"
              on:change={handleImageSelect}
              style="display: none"
            />
            <i class="fas fa-image" style="font-size: 2rem; color: #ccc; margin-bottom: 0.5rem;"></i>
            <p>Ïù¥ÎØ∏ÏßÄÎ•º ÏÑ†ÌÉùÌïòÍ±∞ÎÇò ÎìúÎûòÍ∑∏ÌïòÏó¨ ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî</p>
            <p style="font-size: 0.75rem; color: #666;">ÏµúÎåÄ 5MB, JPG/PNG ÌòïÏãù</p>
          </div>
          
          {#if formData.activityImageUrl}
            <div class="image-preview">
              <img src={formData.activityImageUrl} alt="ÌôúÎèô Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞" />
            </div>
          {/if}
        </div>
      </div>

      {#if error}
        <div class="error-message">{error}</div>
      {/if}

      <div class="modal-actions">
        <button class="cancel-button" on:click={closeModal} disabled={isLoading}>
          Ï∑®ÏÜå
        </button>
        <button 
          class="submit-button" 
          on:click={mode === 'create' ? createLesson : updateSettings}
          disabled={isLoading || !formData.title.trim()}
        >
          {#if isLoading}
            <div class="loading-spinner"></div>
          {/if}
          {mode === 'create' ? 'ÏàòÏóÖ ÏÉùÏÑ±' : 'ÏÑ§Ï†ï Ï†ÄÏû•'}
        </button>
      </div>
    </div>
  </div>
{/if}