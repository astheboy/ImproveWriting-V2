rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 개발 환경을 위한 임시 규칙 - 인증된 사용자(익명 포함)는 모든 접근 허용
    // TODO: 프로덕션에서는 더 엄격한 규칙으로 변경 필요
    
    // 사용자 문서 - 본인 것만 읽기/쓰기 가능
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // 클래스룸 컬렉션 - 인증된 사용자는 읽기 가능, 교사만 쓰기 가능
    match /classrooms/{classId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        (request.auth.uid == resource.data.teacherId || 
         request.auth.uid == request.resource.data.teacherId);
      
      // 클래스 서브컬렉션들 - 인증된 사용자는 모두 접근 가능 (개발용)
      match /{subcollection=**} {
        allow read, write: if request.auth != null;
      }
    }
    
    // 레슨 컬렉션 - 인증된 사용자는 읽기 가능, 교사만 생성/수정/삭제
    match /lessons/{lessonId} {
      allow read: if request.auth != null;
      allow create, update: if request.auth != null;
      allow delete: if request.auth != null && 
        (request.auth.uid == resource.data.teacherId || 
         request.auth.uid == resource.data.createdBy);
      
      // 레슨 서브컬렉션들 - 참여자는 모든 접근 가능 (개발용)
      match /{subcollection=**} {
        allow read, write: if request.auth != null;
      }
    }
    
    // 클래스 멤버 컬렉션
    match /classMembers/{memberId} {
      allow read, write: if request.auth != null;
    }
    
    // 개발용 - 나머지 모든 컬렉션은 인증된 사용자에게 허용
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}